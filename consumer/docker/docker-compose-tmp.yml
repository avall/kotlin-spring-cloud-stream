version: '3.5'
services:
#  mysql:
#    container_name: mysql
#    image: mysql/mysql-server:5.7
#    environment:
#      MYSQL_DATABASE: test
#      MYSQL_ROOT_PASSWORD: admin
#      MYSQL_ROOT_HOST: '%'
#    ports:
#      - 3306:3306
#    restart: always

  rabbitmq-solved:
    container_name: rabbitmq-wefox-challenge-solved
    hostname: api-rabbit
    image: rabbitmq:3.7.5-management
    ports:
      - 15672:15672
      - 5672:5672
#    networks:
#      - rabbitmq



  postgres-solved:
    container_name: postgres-wefox-challenge-solved
    image: postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-wefox}
      PGDATA: /data/postgres
#    volumes:
#      - postgres:/data/postgres
    ports:
      - "5432:5432"
#    networks:
#      - postgres
    restart: unless-stopped


#  pgadmin:
#    container_name: pgadmin-wefox
#    image: dpage/pgadmin4
#    environment:
#      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-wefox@wefox.com}
#      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-admin}
#    volumes:
#      - pgadmin:/root/.pgadmin
#    ports:
#      - "${PGADMIN_PORT:-5050}:80"
#    networks:
#      - postgres
#    restart: unless-stopped



  challenge-wefox-solved:
    build:
      context: ./
      #real folder NOT docker folder
      dockerfile: Dockerfile
      args:
        MAVEN_REPO_USERNAME: ${MAVEN_REPO_USERNAME}
        MAVEN_REPO_PASSWORD: ${MAVEN_REPO_PASSWORD}
    volumes:
    - .:/app
    - ~/.m2:/root/.m2
    working_dir: /app
    ports:
      - 8080:8080
      - 5005:5005
#    command: mvn clean spring-boot:run
    command: >
      bash -c "/wait-for-it.sh --timeout=0 postgres:5432 && /wait-for-it.sh --timeout=0 rabbitmq:5672 && ./mvnw package -Dmaven.test.skip=true && java -jar -Xss1024k  -Xms128m  -Xmx128m  -XX:+UnlockExperimentalVMOptions  -XX:+UseCGroupMemoryLimitForHeap -XX:CICompilerCount=2 -XX:+UseG1GC   -XX:+UseStringDeduplication   -XX:MaxGCPauseMillis=1000  -XX:+ParallelRefProcEnabled   -XX:+PrintReferenceGC  -XX:G1HeapRegionSize=4m /app/target/api-1.0.0.RELEASE.jar"
    ##      bash -c "/docker_virtual_ms_data/wait-for-it.sh --timeout=0 redis:6379 eureka:8300 && mvn -Dmaven.test.skip=true spring-boot:run"


    depends_on:
      - rabbitmq-solved
#      - mysql
      - postgres-solved

#networks:
#  postgres:
#    driver: bridge
#  rabbitmq:
#    driver: bridge

#volumes:
#  postgres:
#  pgadmin: